name: CI/CD Pipeline  

on:  
  push:  
    branches:  
      - main  
  pull_request:  
    branches:  
      - main  

    jobs:  
      build:  
        runs-on: ubuntu-latest  

        steps:  
        # Step 1: Check out code  
        - name: Check out code  
          uses: actions/checkout@v2  

        # Step 2: Install AWS SAM CLI  
        - name: Install AWS SAM CLI  
          run: |  
            sudo apt-get update  
            sudo apt-get install -y python3-pip  
            pip3 install aws-sam-cli  

        # Step 3: List project files for debugging  
        - name: List project files  
          run: ls -R  

        # Step 4: Configure AWS credentials  
        - name: Configure AWS credentials  
          uses: aws-actions/configure-aws-credentials@v1  
          with:  
            aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}  
            aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}  
            aws-region: 'eu-west-1'  
        
        # Step 5: Package SAM  
        - name: Package SAM  
          run: |  
            sam package --template-file template.yaml --s3-bucket child-health-data-bucket --output-template-file output.yaml  

        # Step 6: Deploy SAM  
        - name: Deploy SAM  
          run: |  
            set -e  
            sam deploy --template-file output.yaml --stack-name child-health-data-platform --capabilities CAPABILITY_IAM --confirm-changeset --no-fail-on-empty-changeset
